# Azure-Honeynet-SOC
# Building a SOC + Honeynet in Azure (Live Traffic)
![Cloud Honeynet / SOC](https://i.imgur.com/XKqCUbW.jpg)

## Introduction 

In this project, I build a mini honeynet in Azure and ingest log sources from various resources into a Log Analytics workspace, which is then used by Microsoft Sentinel to build attack maps, trigger alerts, and create incidents. I measured some security metrics in the insecure environment for 24 hours, apply some security controls to harden the environment, measure metrics for another 24 hours, then show the results below. The metrics we will show are:

- SecurityEvent (Windows Event Logs)
- Syslog (Linux Event Logs)
- SecurityAlert (Log Analytics Alerts Triggered)
- SecurityIncident (Incidents created by Sentinel)
- AzureNetworkAnalytics_CL (Malicious Flows allowed into our honeynet)

## Architecture Before Hardening / Security Controls
![Architecture Diagram](https://i.imgur.com/eIntffG.jpg)

## Architecture After Hardening / Security Controls
![Architecture Diagram](https://i.imgur.com/uBGlTSG.jpg)

The architecture of the mini honeynet in Azure consists of the following components:

- Virtual Network (VNet)
- Network Security Group (NSG)
- Virtual Machines (2 windows, 1 linux)
- Log Analytics Workspace
- Azure Key Vault
- Azure Storage Account
- Microsoft Sentinel

## Stage 1:Creating Honeynet Enviorment
Before the changes, all resources were initially deployed and made accessible to the internet, including Virtual Machines with open Network Security Groups. Additionally, all other resources had public endpoints visible to the internet, making private endpoints unnecessary.

## Stage 2: Simulated Attacks, Logging & Monitoring
As I awaited people from around the world to discover my honeynet, I performed simulated attacks using PowerShell to manually trigger various events. These simulated attacks included Brute Force Attempts, Malware (EICAR Test File), AAD Brute Force Failure/Success,  Windows Brute Force Success and Azure account Privilege Escalation. 

Subsequently, I leveraged KQL queries to extract data from different logs, allowing me to analyze these triggered events as well as alerts generated by actual attackers to my Log Analystics Workspace.

## Stage 3: Analysis & Incident Response
During the 24-hour period of running the insecure environment, I thoroughly assessed multiple incidents that were generated. For each incident, I conducted a comprehensive analysis of pertinent information, including the entities responsible for the attacks (such as IP addresses), the tactics and techniques employed, the type of attack executed, and the timeline of each incident. Additionally, I delved deeper into the entity's IP address to examine any associated alerts connected to said IP addresses and determine whether the incident was a true positive or a false positive. By recording all these details I left a clear and consist paper trail for other anylsts to follow as a future reference.This meticulous investigation allowed me to gain valuable insights into the nature and impact of the incidents, facilitating accurate evaluation and appropriate response measures.

## Stage 4: 
Upon completing the analysis of these incidents, I promptly implemented security measures to safeguard the environment. The security controls employed included disabling public access to the virtual machines, disabling the NSG firewall rule for open access and blob storage account. To enhance the security posture further, I created private endpoints for both the storage account and virtual machine, thereby ensuring access is limited to authorized entities only. Additionally, an additional network security group (NSG) was established to fortify the protection of the subnet. To restrict traffic and minimize potential risks, a specific NSG rule was generated, allowing inbound traffic to the virtual machines solely from my own IP address source. Furthermore, to reinforce the security of the key vault, private links were enabled. These rigorous security protocols were implemented in alignment with the NIST 800-53 regulatory compliance standards, ensuring comprehensive adherence to recognized best practices and industry guidelines. By taking these proactive steps, I bolstered the overall security posture of the environment, mitigating potential vulnerabilities and ensuring the confidentiality, integrity, and availability of critical resources.

## Stage 5: The Final Resuls
## Attack Maps Before Hardening / Security Controls
![NSG Allowed Inbound Malicious Flows](https://i.imgur.com/1qvswSX.png)<br>
![Linux Syslog Auth Failures](https://i.imgur.com/G1YgZt6.png)<br>
![Windows RDP/SMB Auth Failures](https://i.imgur.com/ESr9Dlv.png)<br>

## Metrics Before Hardening / Security Controls

The following table shows the metrics we measured in our insecure environment for 24 hours:
Start Time 2023-05-03 02:06:45
Stop Time 2023-05-04 02:06:45

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 107,910
| Syslog                   | 2,514
| SecurityAlert            | 5
| SecurityIncident         | 72
| AzureNetworkAnalytics_CL | 2286

## Attack Maps Before Hardening / Security Controls

```All map queries actually returned no results due to no instances of malicious activity for the 24 hour period after hardening.```

## Metrics After Hardening / Security Controls

The following table shows the metrics we measured in our environment for another 24 hours, but after we have applied security controls:
Start Time 2023-05-06 02:06:45
Stop Time	2023-05-07 02:06:45

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 11,010
| Syslog                   | 24
| SecurityAlert            | 0
| SecurityIncident         | 0
| AzureNetworkAnalytics_CL | 0

## Conclusion

For this project, a miniature honeynet was built in Microsoft Azure, and log sources were seamlessly integrated into a Log Analytics workspace. Microsoft Sentinel played a pivotal role in this endeavor, utilizing the ingested logs to trigger alerts and generate incidents. As part of the project assessment, metrics were diligently measured within the insecure environment before the implementation of security controls. Subsequently, after implementing the prescribed security measures, metrics were measured again to evaluate their impact.

Significantly, the implementation of NIST 800-53 and CIS security controls resulted in a substantial reduction in the number of security events and incidents encountered. This outcome serves as a clear testament to the effectiveness of the security controls deployed. By successfully minimizing the occurrence of security-related events, the project demonstrated the tangible benefits of employing robust security measures within the network environment.

It is worth noting that the observed reduction in security events and incidents was achieved within the specific context of the project's 24-hour timeline. Additionally, it is important to consider that the network resources were heavily utilized by the regular users (Me) and it is plausible that fewer numbers of security events and alerts could have been generated during this period had attacks and login attempt not been simulated to gaurentee some log traffic. Nonetheless, the overall positive impact of the implemented security controls on mitigating security risks and minimizing potential threats remains evident.
